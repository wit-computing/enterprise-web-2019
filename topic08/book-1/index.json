


  {
  
  
    "properties" : {},
  
  "type" : "lab",
  "title" : "Lab-node2",
  "img" : "img/main.png",
  "videoid" : "none",
  "objectives" : "<p>This lab uses Express implement APIs for the contact and Hacker News examples.  In this lab you will use routing, parameterise URLs, and parsing Middleware.</p>",
  "folder" : "book-1",
  "link" : "index.html",
  "los": [
   ]
,
  "chapters" : [
  
    {
    "title": "##Node and Express 2",
    "shortTitle": "Lab-node2",
    "contentMd" : "##Node and Express 2\r\n\r\nThis lab uses Express implement APIs for the contact and Hacker News examples.  In this lab you will use routing, parameterise URLs, and parsing Middleware.\r\n"
    },
  
    {
    "title": "# Contacts API",
    "shortTitle": "01",
    "contentMd" : "# Contacts API\r\nWe will enhance the Contacts API from last weeks lab. The following is a suggested API design for Contacts API.\r\n\r\n\r\n# API Design\r\nWe are going to create an API to manage contact data. The proposed API is as follows:\r\n\r\n\r\n\r\n![Contacts API](./img/contacts_api.png)\r\n\r\n### Set up\r\n\r\n+ User the **node-lab1** folder from last weeks lab as the starting point for this lab. If you do not have a solution for last weeks lab, you can get it from the labs folder in the examples repo at https://github.com/fxwalsh/ewd-examples-2019.git.\r\n\r\n+ Install the following packages in your lab folder.\r\n\r\n> ```script\r\nnpm install --save body-parser\r\nnpm install --save lodashgit \r\n```\r\nBody-parser is a middleware that express can use to parse json.\r\n\r\n+ Update index.js to import and use **body-parser** in it's middleware stack.\r\n\r\n> ```javascript\r\nimport bodyParser from 'body-parser';\r\n....\r\n//configure body-parser\r\napp.use(bodyParser.json());\r\napp.use(bodyParser.urlencoded());\r\n....\r\n```\r\n\r\n+ Before we go any further, test the contacts API using your Rest client(e.g. Postman). This should be still working the same from last weeks lab.\r\n![contacts API](./img/contacts_api_1.png)\r\n\r\n\r\n## Add a Contact\r\n+ Now replace the contents of the contacts routing script, **/api/contacts/index.js**, with the following code.\r\n\r\n```javascript\r\nimport express from 'express';\r\nimport contacts from './contacts';\r\n\r\nconst router = express.Router();\r\n\r\nrouter.get('/', (req, res) => {\r\n  res.send({ contacts: contacts });\r\n});\r\n\r\nrouter.post('/', (req, res) => {\r\n\t\tlet newContact = req.body;\r\n\t\tif (newContact){\r\n          contacts.push({name: newContact.name, address : newContact.address, phone_number: newContact.phone_number }) ;\r\n          res.status(201).send({message: \"Contact Created\"});\r\n      }else{\r\n      \t  res.status(400).send({message: \"Unable to find Contact in request. No Contact Found in body\"});\r\n      }\r\n});\r\n\r\nexport default router;\r\n```\r\nThe above script adds a HTTP post route that gets a new contact data from the request body (``req.body``) and pushes it onto the contacts list.\r\n\r\n- Test with your Rest Client. You will need to supply a JSON representation of the new client in the HTTP request **body** and make sure to select **post** as the HTTP method.\r\n\r\n![Add contact (HTTP post)](./img/contacts_post.png)\r\n\r\nAll going well, you should see a successfull reponse similar to the following:\r\n\r\n![Add contact (HTTP post)](./img/contacts_post_success.png)\r\n\r\n## Update a Contact\r\n\r\n+ Updating a contact involves replacing a contact with the new data in the HTTP request body. This corresponds to a HTTP PUT request. For now, use the phone number as the unique key to identify contacts. Add the following routing code to the end of **/api/contacts/index.js**.\r\n\r\n\r\n```javascript\r\n// Update a contact\r\nrouter.put('/:id', (req, res) => {\r\n     const key = req.params.id;\r\n     const updateContact = req.body;\r\n     const index = contacts.map((contact)=>{\r\nreturn contact.phone_number;\r\n}).indexOf(key);\r\n            if (index !== -1) {\r\n               contacts.splice(index, 1, {name: updateContact.name, address: updateContact.address,\r\n               phone_number: updateContact.phone_number});\r\n               res.status(200).send({message: 'Contact Updated'});\r\n              } else {\r\n          res.status(400).send({message: 'Unable to find Contact in request. No Contact Found in body'});\r\n      }\r\n});\r\n```\r\n\r\nTest using a Rest client by doing a **HTTP PUT** using\r\nthe  URL of an existing contact as follows and include a JSON document in the HTTP body to replace it.\r\n\r\n > http://localhost:8080/api/contacts/934-4329\r\n\r\nUsing Postman, you should see something similar to the following: \r\n\r\n![Update Contact (HTTP Put)](./img/put.png)\r\n\r\n## Delete a Contact\r\n\r\n+ Include the following function and test that the function removes a contact.(e.g. perform a HTTP DELETE on http://localhost:8080/api/contacts/934-4329). You do not need to provide any body data for a delete.\r\n\r\n```javascript\r\n// Delete a contact\r\nrouter.delete('/:id', (req, res) => {\r\n     const key = req.params.id;\r\n     const index = contacts.map((contact)=>{\r\nreturn contact.phone_number;\r\n}).indexOf(key);\r\n    if (index > -1) {\r\ncontacts.splice(index, 1);\r\n        res.status(200).send({message: `Deleted contact with phone_number: ${key}.`});\r\n    } else {\r\n      res.status(400).send({message: `Unable to find contact with phone_number: ${key}.`});\r\n      }\r\n});\r\n```\r\n\r\nCheck by performing a Delete followed by a Get.\r\n\r\n## Commit it\r\n\r\nCommit the changes you just made to your repo.\r\n\r\n```\r\ngit add --all\r\ngit commit -m \"added routing for add,update,delete contact\"\r\n```\r\n"
    },
  
    {
    "title": "# Hacker News API",
    "shortTitle": "02",
    "contentMd" : "# Hacker News API\r\n\r\nNow we will create an API for [Hacker News](https://news.ycombinator.com/). Hacker News is a social news website focusing on computer science and entrepreneurship. In general, content that can be submitted is defined as \"anything that gratifies one's intellectual curiosity\".The following is a suggested API design for Hacker News Posts. \r\n\r\nNote that the URL parameters arepreceeded by a colon(\":\")\r\n\r\n![Hacker News API](./img/hacker_api.png)\r\n\r\n# Set up\r\n+ Create a new *posts* directory in the *api* directory for the Hacker News  API scripts.\r\n\r\n```script\r\n+api\r\n  +posts\r\n```\r\n\r\n\r\n+ In */api/posts*, create two new javascript files, *stubAPI.js* and *index.js*.:\r\n\r\n```script\r\n+api\r\n   +posts\r\n      |- stubAPI.js\r\n      |- index.js\r\n```\r\n\r\n## StubAPI.js\r\n\r\n+ The *stubAPI.js* will take the place of the Mongo database for the time being. In *stubAPI.js*, enter the following code:\r\n\r\n```javascript\r\nimport _ from 'lodash';\r\n\r\n  const posts = [\r\n         {id: 1,\r\n            title: 'India - Tiger population sees 30% increase.',\r\n            link: 'http://www.bbc.com/news/world-asia-30896028',\r\n            username: 'jbloggs',\r\n            comments: [],\r\n            upvotes: 10,\r\n          },\r\n         {\r\n            id: 2,\r\n            title: 'The button that is not.',\r\n            link: 'http://blog.nuclearsecrecy.com/2014/12/15/button-isnt/',\r\n            username: 'notme',\r\n            comments: [],\r\n            upvotes: 12,\r\n          },\r\n          {\r\n            id: 3,\r\n            title: 'Google Nears $1B Investment in SpaceX',\r\n            link: null,\r\n            username: 'notme',\r\n            comments: [],\r\n            upvotes: 12,\r\n          },\r\n          {\r\n            id: 4,\r\n            title: 'Coinbase Raises $75M from DFJ Growth, USAA, and More',\r\n            link: 'http://blog.coinbase.com/post/108642362357/coinbase-raises-75m-from-dfj-growth-usaa-nyse',\r\n            username: 'psmith',\r\n            comments: [],\r\n            upvotes: 2,\r\n          },\r\n      ];\r\n\r\n\r\n     const stubAPI = {\r\n         getAll: () => {\r\n            return posts;\r\n          },\r\n         add: (t, l) => {\r\n              if (!(t && l)) return false;\r\n              let id = 1;\r\n              const last = _.last(posts);\r\n              if (last) {\r\n                 id = last.id + 1;\r\n              }\r\n              let len = posts.length;\r\n              let newLen = posts.push({\r\n                  'id': id,\r\n                 'title': t, 'link': l, 'username': '', 'comments': [], 'upvotes': 0});\r\n               return newLen > len?id:-1;\r\n              },\r\n         upvote: (id) => {\r\n             const index = _.findIndex(posts,\r\n                   (post) => {\r\n                    return post.id == id;\r\n                  } );\r\n             if (index !== -1) {\r\n                  posts[index].upvotes += 1;\r\n                  return true;\r\n                }\r\n              return false;\r\n           },\r\n         getPost: (id) => {\r\n            let result = null;\r\n            const index = _.findIndex(posts,\r\n                   (post) => {\r\n                    return post.id == id;\r\n                  } );\r\n             if (index !== -1) {\r\n                result = posts[index];\r\n                    }\r\n            return result;\r\n            },\r\n         addComment: (postId, c, n) => {\r\n            let result = false;\r\n            const post = stubAPI.getPost(postId);\r\n            let id = 1;\r\n            if (post) {\r\n            const last = _.last(post.comments);\r\n            if (last) {\r\n               id = last.id + 1;\r\n            }\r\n            post.comments.push({'id': id,\r\n                     'comment': c, 'author': n, 'upvotes': 0} );\r\n            result = true;\r\n            }\r\n          return result;\r\n            },\r\n         upvoteComment: (postId, commentId) => {\r\n            let result = false;\r\n            const post = stubAPI.getPost(postId);\r\n            if (post) {\r\n            const index = _.findIndex(post.comments, (c) => {\r\n                      return c.id == commentId;\r\n                    });\r\n             if (index !== -1) {\r\n                 post.comments[index].upvotes += 1;\r\n                 result = true;\r\n                }\r\n              }\r\n            return result;\r\n          },\r\n      };\r\n    export default stubAPI;\r\n```\r\n\r\n# Routing\r\n\r\n+ We will use the same service to handle hacker news as well as contacts. We will need to add the  a new route in index.js for Hacker News. Add the following statements to the top of index.js to import and use the hacker news routes.\r\n\r\n```javascript\r\nimport postsRouter from './api/posts';\r\n\r\n......\r\n\r\napp.use('/api/posts', postsRouter);\r\n```\r\n\r\n# Get and Post\r\n\r\nGetting and posting posts is very similar to the Contacts API. Add the following to **api/posts/index.js**:\r\n\r\n```javascript\r\nimport express from 'express';\r\nimport stubAPI from './stubAPI';\r\n\r\nconst router = express.Router();\r\n\r\n// get all posts\r\nrouter.get('/', (req, res) => {\r\n  const posts = stubAPI.getAll();\r\n  res.send({posts: posts});\r\n});\r\n\r\n\r\n// Add a post\r\nrouter.post('/', (req, res) => {\r\n    const newPost = req.body;\r\n\r\n    if (newPost && stubAPI.add(newPost.title, newPost.link)) {\r\n         return res.status(201).send({message: 'Posts Created'});\r\n    }\r\n    return res.status(400).send({message: 'Unable to find Post in request.'});\r\n});\r\n\r\n// get a post\r\nrouter.get('/:id', (req, res) => {\r\n    const id = req.params.id;\r\n    const post = stubAPI.getPost(id);\r\n\r\n       if (post) {\r\n               return res.status(200).send(post);\r\n              }\r\n              return res.status(404).send({message: `Unable to find Post ${id}`});\r\n});\r\n\r\nexport default router;\r\n```\r\n\r\n+ Save and test using your Rest client. Make sure any changes using POST are visible using GET on http://locahost:8080/api/posts\r\n\r\n## Upvotes and Comments.\r\n\r\n+ Add the following route to */api/posts/index.js* to allow for post upvotes:\r\n\r\n```javascript\r\n// upvote a post\r\nrouter.post('/:id/upvote', (req, res) => {\r\n     const id = req.params.id;\r\n            if (stubAPI.upvote(id)) {\r\n                 return res.status(200).send({message: `Post ${id} Upvoted`});\r\n            }\r\n            return res.status(404).send({message: `Unable to find Post ${id}`});\r\n});\r\n```\r\n\r\nThe function extracts the ``:id`` parameter and uses it to upvote the corresponding post.\r\nTest using your Rest client, making sure upvotes are recorded correctly.\r\n\r\n## Commit it\r\n\r\n+ Commit the changes you just made to your repo.\r\n\r\n```bash\r\ngit add --all\r\ngit commit -m \"added routing for hacker news API\"\r\n```\r\n\r\n## Challenge\r\n\r\nExamine and understand the code for adding a post and upvoting a post. Now try to implement adding and upvoting comments.\r\n\r\n> ** hint: ** an example comment would be ``{\"comment\":\"this is a great post!\", \"author\":\"fxwalsh\"}``. Refer to the API Design table for the correct parametised routing. The functions you will need from the stubAPI are addComment(postId, comment.comment, comment.author) and upvoteComment(postId, commentId).\r\n"
    },
  
    {
    "title": "# Hooking up the React App.",
    "shortTitle": "03",
    "contentMd" : "# Hooking up the React App.\r\nWe will now connect your Hacker News React App to the API. This step requires completion of the React labs.\r\n\r\n## System Architecture\r\n\r\nWe will keep using the **create-react-app** framework you were using previously. **create-react-app** provides a mechanism for working with an API server in development. We can have the development server proxy requests intended for our API server as follows:\r\n\r\n![Development Architecture](./img/architecture.png)\r\n\r\nThe React app makes an API request to localhost:3000, the Webpack development server. The development server proxies that request to the API server. This will remove any Cross-Origin-Resource-Sharing (CORS) issues with the browser.\r\nFor this to work we need to launch both the create-react-app dev server and the API server in order to run the app locally. We also need to get the react dev server to proxy requests to the Express API.\r\n\r\n+ Copy the complete hackerNews app from it's current location and put it in the root of your Express API. It should look like this:\r\n![HackerNews folder](./img/files.png)\r\n\r\n+ The proxy functionality requires the version of *react-scripts* to be greater than 0.8.5. Check this is the case by looking at the dependencies list in */hackernews/package.json*.\r\n\r\n+ Open a console window in the hackerNews folder and start the react app:\r\n```\r\nnpm start\r\n```\r\n\r\nCheck that the app functions as before. If it's not working then check the error messages if any.\r\n\r\n## Set up\r\n\r\n#### Nodemon filter\r\nWe want the nodemon process to ignore any changes in the *hackerNews* folder as these will not affect the API. In the **package.json file in the node app root folder (/package.json**, update the scripts property to the following:\r\n\r\n```json\r\n\"scripts\": {\r\n    \"start\": \"nodemon --ignore hackerNews/* --exec babel-node index.js\"\r\n  }\r\n```\r\n\r\n#### Proxy Server\r\nTo have the React development server proxy our API requests to our Express API server, we need to add the following to the **package.json file in the hackerNews folder (/hackerNewes/package.json).**\r\n\r\n```json\r\n...\r\n\"proxy\":\"http://localhost:8080\",\r\n...\r\n```\r\n\r\n- **You must restart your React app for the new proxy setting to take affect.** \r\nThe Webpack server should now forward any request for unknown resources coming into the Webpack server though to your Express app listening on port 8080.\r\n\r\n#### JSX Linting\r\nCheck that your current linter will not recognise JSX syntax. This should be already the case from the previous lab. If not, install the relevant plugin:\r\n\r\n- Run ``npm install --save-dev eslint-plugin-react``\r\n\r\n- If not already there, add ``\"plugins\": [\"react\"]`` to your .eslintrc config file.\r\n\r\nIn your hackerNews folder, create a new ``.eslintrc.json`` file with the following contents:\r\n\r\n~~~json\r\n{\r\n   \"env\": {\r\n       \"browser\": true,\r\n       \"node\": true\r\n   },\r\n\r\n   \"globals\": {\r\n       \"React\": true\r\n   },\r\n\r\n   \"ecmaFeatures\": {\r\n       \"jsx\": true\r\n   },\r\n\r\n   \"plugins\": [\r\n       \"react\"\r\n   ]\r\n}\r\n~~~\r\n\r\n#### Axios\r\n\r\nWe will need to make http requests to the Express API from the React App. In the **hackerNews** folder, install **axois**.\r\n\r\n```\r\nnpm install --save axios\r\n```\r\n\r\nAxios is a promise-based HTTP client for the browser and node.js. You will use it to make requests to the Express API.\r\n\r\n### Start both servers\r\nYou will need to now start both the react app server and the Express API at the same time. Open two separate command windowsin the hackerNews folder and the parent lab folder. Start the respective servers in both windows:\r\n\r\n```\r\nnpm start\r\n```\r\n\r\nYou should see both processes come to life. As before, they support 'hot code changes' so you should not have to restart the processes as you moake changes.\r\n\r\n## Integrate the Express Hacker News API\r\n\r\nCurrently the Hacker News app uses a stubAPI to mimic a real API. We need to replace this.\r\n\r\n+ create a new script in the *hackerNews/src* folder called **api.js** and enter the following code:\r\n\r\n```javascript\r\nimport axios from 'axios';\r\n\r\nexport const upvote = postId => {\r\n  return axios.post(`/api/posts/${postId}/upvote`)\r\n              .then(resp => resp.data);\r\n};\r\n\r\nexport const getAll = () => {\r\n   return axios('/api/posts')\r\n              .then(resp => resp.data);\r\n};\r\n\r\nexport const getPost = postId => {\r\n  return axios.get(`/api/posts/${postId}`)\r\n              .then(resp => resp.data);\r\n};\r\n\r\nexport const add = (newTitle, newLink) => {\r\n  return axios.post('/api/posts', { title: newTitle, link: newLink })\r\n              .then(resp => resp.data);\r\n};\r\n```\r\n\r\nNotice how the routes match what we've implemented in the Express Hacker News API. The proxy property of the package.json provides the host information required to complete the request.\r\n\r\n+ In the ``hackerNews/src``, edit ``App.js`` as follows: Replace the  ``import api from './dataStore/stubAPI'`` statement with the following.\r\n\r\n```javascript\r\nimport * as api from './api';\r\n```\r\n\r\n+ We are going to include posts as part of the HackerApp component state. In *App.js*, initialise the ``state`` and add the  ``componentDidMount()`` method to the HackerApp component to initialise the posts from the Express API:\r\n\r\n```javascript\r\nexport default class App extends Component {\r\n\r\n    state = {posts: [{}]};\r\n\r\n    componentDidMount() {\r\n        api.getAll().then(resp => {\r\n            this.setState({\r\n                posts: resp.posts\r\n            });\r\n        }).catch(console.error);\r\n    };\r\n\r\n    ...\r\n    ...\r\n```\r\n\r\n+ Now replace the ``render`` function of the HackerApp component with the following code. This replaces the previous use of stubAPI with the new posts state retrieved from the api package.\r\n\r\n```javascript\r\n...\r\n    render() {\r\n        const posts = _.sortBy(this.state.posts, post =>\r\n            post.upvotes);\r\n        return (\r\n            <div className=\"container\">\r\n                <div className=\"row\">\r\n                    <div className=\"col-md-9 col-md-offset-1\">\r\n                        <NewsList posts={posts} \r\n                        upvoteHandler={this.incrementUpvote} />\r\n                    </div>\r\n                </div>\r\n                <div className=\"row\">\r\n                    <div className=\"col-md-9 col-md-offset-1\">\r\n                        <Form handleAdd={ this.addNewsItem } />\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n...\r\n```\r\n\r\nNow have a look at the app in the browser. You should see the list of news items as before. This time, however, they are retrieved from the Express API.\r\nTry to add a new post. You'll notice nothing happens. Next we will update the addPost() method.\r\n\r\n\r\n### Adding a post\r\n\r\n+ Locate the ``addNewsItem()`` function in the App component. Replace it with the following:\r\n\r\n```javascript\r\naddNewsItem = (title, link) => {\r\n        api.add(title,link)\r\n        .then(resp => {\r\n                      const newPost = {\"id\":resp.id,\"title\":title,\"link\":link,\"upvotes\":0, \"comments\":[]};\r\n                      this.setState({posts: this.state.posts.concat([newPost])});\r\n        })\r\n      };\r\n```\r\n\r\nThis function calls the Express API which returns a promise. When the promise is fulfilled, then it pushes the new post onto the posts state property. The HackerApp should react to this state and call the render function again.\r\n\r\nCheck the app in the browser again. You should be able add new posts posts to the list.\r\n\r\nYou can also check, via the API directly, that the new posts are being created.\r\n\r\n### Upvoting a Post\r\n\r\nThe upvote will now cause errors if you try to use it at the moment.\r\nReplace the **incrementUpvote** function in the App compnent with the following:\r\n\r\n\r\n```javascript\r\nincrementUpvote = (id) => {\r\n  api.upvote(id).then(resp=> {\r\n         var upvotedPost = _.find(this.state.posts, post=>post.id == id);\r\n         upvotedPost.upvotes++;  \r\n         this.setState({})\r\n       }) ;\r\n};\r\n```\r\n\r\n## Challenge\r\n\r\nReview your progress so far. Use the same approach to accomplish the following:\r\n\r\n+ integrate the API with the comment page.\r\n+ Update the contactList app to use the API developed in this lab.\r\n"
    }
  
  ]
  }

