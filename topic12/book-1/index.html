<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.10/semantic.min.css"
          type="text/css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/railscasts.min.css"
          rel="stylesheet"/>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery.address/1.6/jquery.address.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.10/semantic.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/java.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/kotlin.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <style>
      

body {
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
  font-size:90%;
  color: black;
}

p {
  margin: 0.5em;
}

pre code {
  font-family: "Monaco";
  font-size: 100%;
}

img {
  box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
  margin:10px;
}

h1, h2, h3 {
  border-bottom:thin solid black;
  margin-bottom: 0.5em;
  margin-top: 1em;
}

h1 {
  font-style:italic;
  font-size:130%;
}

h2 {
  font-size:110%;
}

h3 {
  font-size:100%;
}



      

html, body {
  height: 100%;
  margin: 0;
}
.wrapper {
  height: 100%;
  display: flex;
  flex-direction: column;
}
.footer {
  background: white;
  text-align: right;
}
.content {
  flex: 1;
  overflow: auto;
}



    </style>
  </head>

  
  

  <div class="ui fixed top pointing inverted stackable menu labmenu">
    <header class="header item">
      <i id="toc" class="sitemap icon"></i>
      
        <a href="../index.html">  Continuous Integration.  </a>
      
    </header>
    <div class="right tab-menu menu">
      
        <a class="item" data-tab="Lab-CICD">
          Lab-CICD
        </a>
      
        <a class="item" data-tab="01">
          01
        </a>
      
        <a class="item" data-tab="02">
          02
        </a>
      
        <a class="item" data-tab="03">
          03
        </a>
      
        <a class="item" data-tab="04">
          04
        </a>
      
        <a class="item" data-tab="05">
          05
        </a>
      
    </div>
  </div>


  

  <div class="ui pushable">
    <div class="ui inverted labeled icon left inline vertical sidebar menu">
      <br><br>
      
        
          
            <a class="item"
               href="https://wit-computing.github.io/enterprise-web-2019//topic01/book-1/index.html">Lab-01_JS_Objects </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-computing.github.io/enterprise-web-2019//topic01/book-2/index.html">Lab-02_JS_functions </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-computing.github.io/enterprise-web-2019//topic02/book-1/index.html">Lab-03_HTML_CSS </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-computing.github.io/enterprise-web-2019//topic03/book-1/index.html">Lab-React_Basics </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-computing.github.io/enterprise-web-2019//topic04/book-1/index.html">Lab_React_Data_Flow </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-computing.github.io/enterprise-web-2019//topic04/book-2/index.html">Lab_Static_React_Apps </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-computing.github.io/enterprise-web-2019//topic05/book-1/index.html">Lab-Interactive_Apps </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-computing.github.io/enterprise-web-2019//topic06/book-1/index.html">Lab_React_Routing </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-computing.github.io/enterprise-web-2019//topic07/book-1/index.html">Lab-node1 </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-computing.github.io/enterprise-web-2019//topic08/book-1/index.html">Lab-node2 </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-computing.github.io/enterprise-web-2019//topic09/book-1/index.html">Lab-node3 </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-computing.github.io/enterprise-web-2019//topic09/book-2/index.html">Lab-Optional-Sessions </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-computing.github.io/enterprise-web-2019//topic10/book-01/index.html">Authentication-JWT </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-computing.github.io/enterprise-web-2019//topic11/book-1/index.html">api-testing-ES6 </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-computing.github.io/enterprise-web-2019//topic12/book-1/index.html">Lab-CICD </a>
          
        
      
    </div>
    <div class="pusher" tabindex="-1">
      <div class="ui basic segment">
        <br>
        
          <div class="ui tab segment lab" data-tab="Lab-CICD">
            <h1>CI/CD.</h1>
<p>Create a <strong>continuous integration and deployment (CI/CD) pipeline</strong> for an Enterprise Web development project.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="01">
            <h2>Startup.</h2>
<p>We will be using the following cloud-based services:</p>
<ol>
<li>GitHub for hosted version control.</li>
<li>Travis CI for continuous integration.</li>
<li>Surge for static website hosting (including Single Page App hosting). </li>
</ol>
<p>The Contact List app will be used as the context for this lab exercise. In normal circumstances the SPA and Web API would both be deployed, albeit on different platforms, e.g. SPA on Surge, API on Heroku. For convenience we are using a standalone version of the Contact List SPA - it is using a stub API. </p>
<p>Download the source code required from <a href="./archives/start.zip">here</a>. In a terminal window, go to the base folder (<code>cicdLab</code>) and install the required packages:</p>
<pre><code>      $ npm install</code></pre>
<p>Create a local Git repo:</p>
<pre><code>   $ git init
   % git add -A
   $ git commit -m &quot;Fully functional app&quot;</code></pre>
<p>Build a static version of the SPA:</p>
<pre><code>   $ npm run build</code></pre>
<p>The new <code>build</code> sub-folder  contains the generated static version (a deployable version).</p>
<p><img src="./img/static.png" alt=""></p>
<p>We need a standard web server to test the static app. In an earlier lab we installed httpserver ($ npm install httpserver -g). In the terminal window start the server from the <code>build</code> folder:</p>
<pre><code>    $ cd build
    $ httpserver -p 8080</code></pre>
<p>In the browser navigate to: <a href="http://localhost:8080/">http://localhost:8080/</a>. The app should function as before.</p>
<p>On GitHub, create a new repo, called <code>contacts2019</code>. Make it a remote for this project (cd to the base folder first):</p>
<pre><code>    $ git remote add origin https://github.com/[.. your username ...]/contacts2019.git
    $ git push origin master </code></pre>
<p>Any generated files should never be stored in a repository. We have already included the build folder in <code>.gitignore</code> to safeguard against this.</p>
<p>Create an account on <a href="https://travis-ci.org/">Travis CI</a>, using your GitHub credentials for authentication. On Travis, navigate to your Settings page:</p>
<p><img src="./img/accounts.png" alt=""></p>
<p> Click the <em>Sync Account</em> button on the left (Sync with GitHub) and turn on  the <code>contacts2019</code> repo, as illustrate below:</p>
<p><img src="./img/sync.png" alt=""></p>
<p>This has created a &#39;web hook&#39; between GitHub and Travis. Github will notify Travis when a push event occurs on the repository (see later).</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="02">
            <h2>First Travis build.</h2>
<p>In the base folder create a file named <code>.travis.yml</code> and set its content to the following:</p>
<pre><code>dist: trusty
language: node_js
node_js:
- stable
script:
- npm run build</code></pre>
<p>We will expand the content of this file later in the lab. NOTE: The YAML syntax is sensitive to incorrect indentation and alignment so take care to type it as prescribed in the snippets provided.</p>
<p>Travis uses this file to compile the set of instructions it gives to the worker VM that performs the app build process. The first line in the file indicates the version of Ubuntu it requires the VM to install. The next few lines causes the VM to install the Node platform. The script section specifies the build steps.</p>
<p>Commit and push to GitHub:</p>
<pre><code>$ git add -A
$ git commit -m &quot;First Travis builds&quot;
$ git push origin master</code></pre>
<p>The web hook between GitHub and Travis means a &#39;git push&#39; operation will initiate a build by Travis on a worker VM. Our  simple build only involved:</p>
<ul>
<li>Provisioning a VM and installing Ubuntu on it</li>
<li>The VM:<ul>
<li>clone the repo</li>
<li>Installs Node </li>
<li>installs the required modules, based on <code>package.json</code></li>
<li>Runs &#39;npm run build&#39;</li>
</ul>
</li>
</ul>
<p>In a web browser, navigate to your Travis account and select this project&#39;s build page. Make sure the overall build outcome is recorded as <em>passed</em>  before continuing. </p>
<p><img src="./img/first.png" alt=""></p>
<p>Travis sends an email (to the email address associated with your GitHub account) on every change in the build status. We will configure it to only email on build failure. Modify <code>.travis.yml</code> as follows:</p>
<pre><code>. . . as before . . . 
node_js:
- stable
notifications:
    email:
        recipients:
        - one@example.com      # change to your own address
        - other@example.com    # use other (optional)
        on_success: never        # default: change
        on_failure: always       # default: always
script:  
. . . as before . . . </code></pre>
<p>Commit locally (no need to push to GitHub yet):</p>
<pre><code>    $ git add -A
    $ git commit -m &quot;Notify on build failure only&quot;</code></pre>

          </div>
        
          <div class="ui tab segment lab" data-tab="03">
            <h2>Deployment.</h2>
<p>We will use the <a href="https://surge.sh/">Surge</a> platform to host our React app. Ultimately we want deployment to occur automatically when a Travis build has passed, however, the initial deployment must be manual. Install the Surge CLI:</p>
<pre><code> $ npm install -g surge</code></pre>
<p>We deploy the static/production version of the app. From the base folder type:</p>
<pre><code> $ surge ./build</code></pre>
<p>If you have not previously used Surge it will how prompt you to create an account. Then it detects the project you want to deploy - confirm this. It suggests a domain name for you website but you can override if you wish. Hit return and Surge takes care of the rest. In the browser navigate to the new site, for example:</p>
<p><img src="./img/manual.png" alt=""> </p>
<p>Subsequent deployments can now be automated. In <code>.travis.yml</code> add a deploy section:</p>
<pre><code>. . . as before . . . 
script:
- npm run build
deploy:
   provider: surge
   skip_cleanup: true
   domain: your-domain.surge.sh
   project: ./build/
   on:
       branch: master</code></pre>
<p>Make sure to change the domain property above to your chosen name. We need to give Travis permission to deploy to Surge. From the base folder, generate a token for this app: </p>
<pre><code> $ surge token</code></pre>
<p>On Travis, go to the app&#39;s base page and select the &#39;Settings&#39; view.</p>
<p><img src="./img/settings.png" alt=""></p>
<p>Scroll down to the &#39;Environment Variables&#39; section and declare two variables, SURGE_LOGIN (your email address) and SURGE_TOKEN (from above): </p>
<p><img src="./img/env.png" alt=""></p>
<p>To prove the deployment will work, make a small change to the app. For example, in <code>src/components/header.js</code> change the header as shown below:</p>
<pre><code>&lt;h2&gt;My Private Contact List &lt;span className=&quot;badge&quot;&gt; {this.props.noContacts}&lt;/span&gt;&lt;/h2&gt;</code></pre>
<p>Push to GitHub to trigger the CI/CD process:</p>
<pre><code>  $ git add -A
  $ git commit -m &quot;First auto-deploy&quot;
  $ git push origin master</code></pre>
<p>In the browser, go to your Travis account and wait until the build is completed. Assuming it &#39;passed&#39;, scroll to the bottom of the build console output and notice the app was deployed. Now browse to the app on Surge and it should reflect the change we made to the header.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="04">
            <h2>Adding Tests.</h2>
<p>We should really develop some tests for the app and only deploy if those tests pass. We will use the <a href="https://www.cypress.io/">Cypress</a> testing framework - already installed from <code>package.json</code>.</p>
<p>Start the Cypress interactive test runner:</p>
<pre><code>$ npx cypress open</code></pre>
<p>As this is the first run it creates a folder structure for your test code - see <code>cicdLab/cypress</code>. In <code>cicdLab/cypress/integration/examples</code> their are lots of coding examples for reference purposes. Remove this folder (or make a copy if you wish to learn more about Cypress later). Stop the test runner.</p>
<p>Create <code>cicdLab/cypress/integration/contacts-add.spec.js</code> and paste in this code:</p>
<pre><code>describe(&quot;Contact Add&quot;, () =&gt; {
  beforeEach(() =&gt; {
    cy.visit(&quot;/&quot;);
  });

  it(&quot;allows a contact to be added&quot;, () =&gt; {
    cy.get(&quot;span.badge&quot;).contains(&quot;5&quot;);
    cy.get(&quot;input[placeholder=Name]&quot;).type(&quot;user X&quot;);
    cy.get(&quot;input[placeholder=Address]&quot;).type(&quot;22 main street&quot;);
    cy.get(&#39;input[placeholder=&quot;Phone No.&quot;]&#39;).type(&quot;055 123456&quot;);
    cy.get(&quot;button&quot;)
      .contains(&quot;Add Contact&quot;)
      .click();
    cy.get(&quot;span.badge&quot;).contains(&quot;6&quot;);
  });
});</code></pre>
<p>Cypress uses <code>cypress.json</code> for configuration. Add the following entry to it:</p>
<pre><code>{
    &quot;baseUrl&quot;: &quot;http://localhost:8080/&quot;
}</code></pre>
<p>In the test code we have the command:</p>
<blockquote>
<p>cy.visit(&quot;/&quot;)</p>
</blockquote>
<p>Our configuration causes this command to visit: <a href="http://localhost:8080/">http://localhost:8080/</a>. We must ensure the app is accessible from this URL before running the test. Start the web server:</p>
<pre><code>    $ cd build
    $ httpserver -p 8080</code></pre>
<p>In a second terminal start the test runner (from the base folder):</p>
<pre><code> $ npx cypress open</code></pre>
<p>Click the test name on the left to run it. </p>
<p><img src="./img/add.png" alt=""></p>
<p>Assuming the test result is &#39;green&#39; (success), we should now get our CI build to include testing. However, Travis must use the headless test runner instead of the interactive one. Replace the content of <code>.travis.yml</code> with the following:</p>
<pre><code>dist: trusty
language: node_js
node_js:
- &quot;stable&quot;
notifications:
    email:
        recipients:
        - one@example.com      # change to your own address
        - other@example.com    # use other (optional)
        on_success: never        # default: change
        on_failure: always  
cache:
  directories:
  - node_modules
before_script:
- npm install -g httpserver
- npm run build
- cd build &amp;&amp; httpserver -p 8080 &amp;
script:
- npx cypress run
deploy:
  provider: surge
  skip_cleanup: true
  domain: mycontacts.surge.sh
  project: ./build
  on:
    branch: cypress-oldUI</code></pre>
<p>[You must change the relevant lines according to your profile.]</p>
<p>In the &#39;before_script&#39; section we install httpserver, build the app and start the server in background mode (&amp;). In the &#39;script&#39; section we simply execute the tests. Only if the tests are successful will the deployment take place.</p>
<p>Push this to GitHub:</p>
<pre><code>$ git add -A
$ git commit -m &quot;Include E2E testing in build process&quot;
$ git push origin master</code></pre>
<p>On Travis, examine the log from the VM and notice the tests are executed and deployment happens. As an experiment, modify <code>cypress/integration/contacts-add.spec.js</code> to force a test fail. For example, change the last line to :</p>
<blockquote>
<blockquote>
<p>cy.get(&quot;span.badge&quot;).contains(&quot;10&quot;);</p>
</blockquote>
</blockquote>
<p>Push this to GitHub:</p>
<pre><code>$ git add -A
$ git commit -m &quot;Experiment: Failing test&quot;
$ git push origin master</code></pre>
<p>This time the build fails and no deployment occurs.</p>
<p>UNDO THE TEST CODE CHANGE and push to Github again.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="05">
            <h2>Completing the tests.</h2>
<p>Create the file <code>cypress/integration/contact-delete.spec.js</code> and add this code:</p>
<pre><code>describe(&quot;Contact Delete&quot;, () =&gt; {
  beforeEach(() =&gt; {
    cy.visit(&quot;/&quot;);
  });

  it(&quot;allows a contact to be deleted&quot;, () =&gt; {
    cy.get(&quot;div.panel-body&quot;).should(&quot;have.length&quot;, 5);
    cy.get(&quot;:nth-child(2) &gt; .panel&quot;)
      .find(&quot;.panel-footer&quot;)
      .find(&quot;button&quot;)
      .contains(&quot;Delete&quot;)
      .click();
    cy.get(&quot;:nth-child(2) &gt; .panel&quot;)
      .find(&quot;.panel-footer&quot;)
      .find(&quot;button&quot;)
      .contains(&quot;Confirm&quot;)
      .click();
    cy.get(&quot;div.panel-body&quot;).should(&quot;have.length&quot;, 4);
  });

  it(&quot;allows a delete operation to be cancelled&quot;, () =&gt; {
    cy.get(&quot;div.panel-body&quot;).should(&quot;have.length&quot;, 5);
    cy.get(&quot;:nth-child(2) &gt; .panel&quot;)
      .find(&quot;.panel-footer&quot;)
      .find(&quot;button&quot;)
      .contains(&quot;Delete&quot;)
      .click();
    cy.get(&quot;:nth-child(2) &gt; .panel&quot;)
      .find(&quot;.panel-footer&quot;)
      .find(&quot;button&quot;)
      .contains(&quot;Undo&quot;)
      .click();
      cy.get(&quot;div.panel-body&quot;).should(&quot;have.length&quot;, 5);
  });
});</code></pre>
<p>Create the file <code>cypress/integration/contacts-edit.spec.js</code> and paste in the following:</p>
<pre><code>describe(&quot;Contact Edit&quot;, () =&gt; {
  beforeEach(() =&gt; {
    cy.visit(&quot;/&quot;);
  });

  it(&quot;allows a contact&#39;s address be edited&quot;, () =&gt; {
    cy.get(&quot;div.panel-body&quot;).should(&quot;have.length&quot;, 5);
    let button = cy
      .get(&quot;:nth-child(2) &gt; .panel&quot;)
      .find(&quot;.panel-footer&quot;)
      .find(&quot;button&quot;)
      .contains(&quot;Edit&quot;);
    button.click();
    let address = cy.get(&quot;:nth-child(2) &gt; .panel&quot;).get(&quot;input:nth-child(2)&quot;);
    address.clear();
    address.type(&quot;22 low Street&quot;);
    cy.get(&quot;:nth-child(2) &gt; .panel&quot;)
      .find(&quot;.panel-footer&quot;)
      .find(&quot;button&quot;)
      .contains(&quot;Save&quot;)
      .click();
    cy.get(&quot;:nth-child(2) &gt; .panel&quot;)
      .get(&quot;p:nth-child(2)&quot;)
      .should(&quot;contain&quot;, &quot;22 low Street&quot;);
  });

  it(&quot;allows a contact&#39;s address edit be cancelled&quot;, () =&gt; {
    cy.get(&quot;div.panel-body&quot;).should(&quot;have.length&quot;, 5);
    let button = cy
      .get(&quot;:nth-child(2) &gt; .panel&quot;)
      .find(&quot;.panel-footer&quot;)
      .find(&quot;button&quot;)
      .contains(&quot;Edit&quot;);
    button.click();
    let address = cy.get(&quot;:nth-child(2) &gt; .panel&quot;).get(&quot;input:nth-child(2)&quot;);
    address.clear();
    address.type(&quot;22 low Street&quot;);
    cy.get(&quot;:nth-child(2) &gt; .panel&quot;)
      .find(&quot;.panel-footer&quot;)
      .find(&quot;button&quot;)
      .contains(&quot;Cancel&quot;)
      .click();
    cy.get(&quot;:nth-child(2) &gt; .panel&quot;)
      .get(&quot;p:nth-child(2)&quot;)
      .should(&quot;not.contain&quot;, &quot;22 low Street&quot;);
  });
});</code></pre>
<p>Run the tests locally first, using the interactive runner:</p>
<pre><code>  $ npx cypress open</code></pre>
<p>Now commit:</p>
<pre><code>$ git add -A
$ git commit -m &quot;Added tests for edit and delete operations&quot;
$ git push origin master </code></pre>
<p>Chech Travis to ensure it passed and deployed.</p>

          </div>
        
      </div>
    </div>
  </div>


  <br>
  <script>
    $(document).on('keydown', function(e) {
  e = e || window.event;
  var nextTab;
  switch (e.which || e.keyCode) {
    case 37: // left
      nextTab = $('.tab-menu a[data-tab].active').prev('a[data-tab]');
      if (!nextTab.length) nextTab = $('.tab-menu a[data-tab]').last();
      nextTab.click();
      $('.pusher').focus();
      break;

    case 39: // right
      nextTab = $('.tab-menu a[data-tab].active').next('a[data-tab]');
      if (!nextTab.length) nextTab = $('.tab-menu a[data-tab]').first();
      nextTab.click();
      $('.pusher').focus();
      break;
  }
});

    $(document).ready(function() {
  $('img').addClass('ui image');

  $('.ui.embed').embed();

  const $images = $('.lab img');
  jQuery.each($images, function(i) {
    if ($images[i].alt.length > 0) {
      const divImg = $(document.createElement('div')).addClass(
        'ui basic segment',
      );
      $($images[i]).wrap(divImg);
      const divLabel = $(document.createElement('div')).addClass(
        'ui blue ribbon label',
      );
      divLabel.append($images[i].alt);
      $(divLabel).insertBefore($images[i]);
    }
  });

  $('.ui.menu .item').tab({
    history: true,
    historyType: 'hash',
  });

  $('.popup').popup();

  $('.ui.sidebar')
    .sidebar({ context: $('.pushable') })
    .sidebar('setting', 'transition', 'slide out')
    .sidebar('attach events', '#toc');
});

  </script>



  <div class="ui bottom fixed borderless right menu">
    <div class="ui right small menu">
      <div class="ui tiny basic message segment">
         Powered by <a href="https://github.com/edeleastar/tutors-ts">tutors-ts.</a> Unless otherwise stated, this work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
      </div>
    </div>
  </div>

  </body>

</html>